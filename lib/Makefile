# $Id: Makefile,v 1.14 2008/01/30 13:19:40 dijkstra Exp $
OS!=uname -s
.include "../platform/${OS}/Makefile.inc"
.include "../Makefile.inc"

SRCSsym=   	error.c lex.c xmalloc.c net.c data.c
OBJSsym+=	${SRCSsym:R:S/$/.o/g}

SRCSprobe=      smart.c
OBJSprobe+=     ${SRCSprobe:R:S/$/.o/g}

CFLAGS+=-I../platform/${OS} -I.

all: libsym.a libprobe.a

${OBJSsym} ${OBJSprobe}: conf.h ../Makefile.inc Makefile

libsym.a: ${OBJSsym}
	@echo building standard library
	@rm -f libsym.a
	@${AR} cq libsym.a `${LORDER} ${OBJSsym} | ${TSORT}`
	${RANLIB} libsym.a

libprobe.a: ${OBJSprobe}
	@echo building probe helper library
	@rm -f libprobe.a
	@${AR} cq libprobe.a `${LORDER} ${OBJSprobe} | ${TSORT}`
	${RANLIB} libprobe.a

conf.h:  Makefile ../Makefile.inc
	@echo Generating $@ on ${OS}
	@echo "/* This file was automagically generated by make */" > $@
	@echo "#define SYMON_CONFIG_FILE \"$(SYSCONFDIR)/symon.conf\""  >> $@
	@echo "#define SYMON_VERSION \"$(V)\"" >> $@
	@echo "#define SYMON_PLATFORM \"${OS}\"" >> $@
	@echo "#include \"../platform/${OS}/platform.h\"" >> $@
	@if [ -f ../platform/${OS}/conf.sh ]; then sh ../platform/${OS}/conf.sh >> $@; fi

clean:
	rm -f conf.h libsym.a ${OBJSsym} ${OBJSprobe}

install: libsym.a libprobe.a

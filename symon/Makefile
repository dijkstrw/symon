# $Id: Makefile,v 1.35 2004/02/24 22:13:20 dijkstra Exp $
.include "../Makefile.inc"

LIBS=	-L../lib -lsymon
SRCS=	symon.c sm_cpu.c sm_debug.c sm_mem.c sm_if.c sm_io.c sm_pf.c sm_mbuf.c sm_proc.c sm_sensor.c readconf.c symonnet.c
OBJS+=	${SRCS:R:S/$/.o/g}
CFLAGS+=-I../lib -I.

all: symon symon.cat8

${OBJS}: conf.h

symon: ${OBJS}
	${CC} -o $@ ${OBJS} ${LIBS}
.ifndef DEBUG
	${STRIP} $@
.endif

clean:
	rm -f conf.h symon symon.cat8 symon.core ${OBJS}

install: symon symon.cat8 symon.conf
	${INSTALL} -c -m 555  -g wheel -o root symon      ${PREFIX}/${BINDIR}
	${INSTALL} -c -m 444  -g wheel -o root symon.cat8 ${PREFIX}/${MANDIR}/cat8/symon.0
	${INSTALL} -d -m 555  -g bin   -o root ${PREFIX}/${SHRDIR}
	${INSTALL} -c -m 555  -g wheel -o root c_config.sh ${PREFIX}/${SHRDIR}
	${INSTALL} -d -m 555  -g bin   -o root ${PREFIX}/${EXADIR}
	${INSTALL} -c -m 444  -g bin   -o root symon.conf ${PREFIX}/${EXADIR}

conf.h:  Makefile
	@echo Generating conf.h
	@echo "/* This file was automagically generated by make */" > $@
	@echo "#define SYMON_CONFIG_FILE \"$(SYSCONFDIR)/symon.conf\""  >> $@
	@echo "#define SYMON_VERSION \"$(V)\"" >> $@
	@case `grep -csq KERN_MBSTAT /usr/include/sys/sysctl.h` in	\
	1)	echo "#define HAS_KERN_MBSTAT	1" >> $@;;		\
	0)	echo "#undef HAS_KERN_MBSTAT" >> $@;;			\
	esac;
	@case `grep -csq "struct sensor" /usr/include/sys/sensors.h` in \
	1)	echo "#define HAS_SENSORS_H	1" >> $@;;		\
	0)	echo "#undef HAS_SENSORS_H" >> $@;;			\
	esac;
	@case `grep -csq "ds_rxfer" /usr/include/sys/disk.h` in         \
	1)	echo "#define HAS_IO2	1" >> $@;;                      \
	0)	echo "#undef HAS_IO2" >> $@;;                           \
	esac

symon.h: conf.h

symon.o: symon.h

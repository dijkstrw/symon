OS!=uname -s
.include "../platform/${OS}/Makefile.inc"
.include "../Makefile.inc"

SRCS=	symux.c readconf.c symuxnet.c share.c
OBJS+=	${SRCS:R:S/$/.o/g}
LIBS+=  ${SYMUX_LIBS} -L../lib -L$(RRDDIR)/lib -lsym -lrrd
CFLAGS+=-I../lib -I$(RRDDIR)/include -I../platform/${OS} -I.

all: symux symux.cat8

symux: ${OBJS}
	${CC} -o $@ ${OBJS} ${LIBS}
.ifndef DEBUG
	${STRIP} $@
.endif

clean:
	rm -f conf.h symux symux.cat8 symux.core ${OBJS}

install: symux symux.8 c_smrrds.sh symux.conf
	${INSTALL} -d -m 555 -g ${INSTALLGROUPDIR} -o ${INSTALLUSER} ${PREFIX}/${BINDIR}
	${INSTALL} -c -m 555 -g ${INSTALLGROUPFILE} -o ${INSTALLUSER} symux	   ${PREFIX}/${BINDIR}/
	${INSTALL} -d -m 555 -g ${INSTALLGROUPDIR} -o ${INSTALLUSER} ${PREFIX}/${MANDIR}/man8
	${INSTALL} -c -m 444 -g ${INSTALLGROUPFILE} -o ${INSTALLUSER} symux.8	   ${PREFIX}/${MANDIR}/man8/symux.8
	${INSTALL} -d -m 555 -g ${INSTALLGROUPDIR} -o ${INSTALLUSER} ${PREFIX}/${SHRDIR}
	${INSTALL} -c -m 544 -g ${INSTALLGROUPFILE} -o ${INSTALLUSER} c_smrrds.sh  ${PREFIX}/${SHRDIR}/
	${INSTALL} -d -m 555 -g ${INSTALLGROUPDIR} -o ${INSTALLUSER} ${PREFIX}/${EXADIR}
	${INSTALL} -c -m 444 -g ${INSTALLGROUPFILE} -o ${INSTALLUSER} symux.conf   ${PREFIX}/${EXADIR}/

cleanipc:
	ipcs | egrep "^m" | awk '{print $$2}' | xargs -n1 ipcrm -m &
	ipcs | egrep "^s" | awk '{print $$2}' | xargs -n1 ipcrm -s

conf.h:  Makefile ../Makefile.inc
	@echo Generating conf.h on ${OS}
	@echo "/* This file was automagically generated by make */" > $@
	@echo "#define SYMUX_CONFIG_FILE \"$(SYSCONFDIR)/symux.conf\""  >> $@
	@echo "#define SYMUX_VERSION \"$(V)\"" >> $@
	@echo "#define SYMUX_PLATFORM \"${OS}\"" >> $@
	@echo "#include \"../platform/${OS}/platform.h\"" >> $@
	@if [ -f ../platform/${OS}/conf.sh ]; then sh ../platform/${OS}/conf.sh >> $@; fi

symux.h: conf.h

symux.o: symux.h
